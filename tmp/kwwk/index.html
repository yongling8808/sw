<!DOCTYPE html>


<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf8"/>
    <!-- tbs jsapi 中间层封装，会有权限白名单控制，前端正常引入到业务中即可,目前还在测试环境，正式上线后切换为https://res.imtt.qq.com/tbs/tbs.js -->
    <script type="text/javascript" src="./tbs.js"></script>
    <title>我的可离线保存页面</title>

<script type="text/javascript">

function register() {
  navigator.serviceWorker.register('serviceworker.js').then( function(serviceWorker) {
});
}

function init()
{
  //判断是否为微信环境
  var isWeChat = /MicroMessenger/i.test(navigator.userAgent);
  if(!isWeChat)
  {
  	//这里测试demo仅非微信场景注册SW，业务可自行调整。
    register();
    alert('非微信环境！');
    return;
  }

  //判断是否为android平台
  var isAndroid = /android/ig.test(navigator.userAgent)
  if(!isAndroid)
  {
    alert('非android平台!');
    return;
  }

  //判断是否为TBS环境
  if (typeof tbsJs == "undefined" || tbsJs.packages == "undefined")
  {
    alert('非TBS环境！');
    return;
  }

  //判断TBS的 jsapi是否已打开
  if(!tbsJs.isTbsJsapiEnabled())
  {
    alert('tbsJs api not enable!');
    return;
  }

	//保存按钮在条件满足的情况才展示
  document.getElementById("saveofflinepage").hidden = false;
}

function savepage() {
	//savepageoffline 是一个异步阻塞型函数，在等待回调过程中最好将button禁用
	document.getElementById("saveofflinepage").disabled = true;
	tbs.app.saveOfflinePage(function(result) {
				document.getElementById("saveofflinepage").disabled = false;
        //这里的reslut{ret,path},当ret为0，方法执行成功，只需按照如下方式填写跳转。当ret为1，方法执行失败，可能是拉新QB错误等，业务可以不做任何处理
        if(result.ret==0)
        {
          var url = 'http://res.imtt.qq.com/TES/kawaweika.html'+'?url='+encodeURIComponent(window.location.href)+'&posid='+encodeURIComponent('33')+'&channelid='+encodeURIComponent('com.tencent.mm')+'&cmd='+encodeURIComponent('saveofflinepage')+'&path='+encodeURIComponent(result.path);
          console.log(url);
          window.location.replace(url);
        }
        else
        {
          //for debug
          alert('保存失败，请联系yongling');
        }
        
      }); 
  }


</script>
<script src="app.js" type="text/javascript"></script>
</head>

<body onload="init()">
<button id="saveofflinepage" hidden="true" onclick="savepage()">savepage</button>
</br>
</br>
</br>
<image src='snowTroopers.jpg'></image>
</br>
</br>
</br>
<button onclick="test()">Out Js Test!</button>
</br>
</br>
<h3>timestamp:20160419144300</h3>

</body>

</html>